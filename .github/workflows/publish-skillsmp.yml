# DISABLED: This workflow is disabled pending SkillsMP setup.
# It currently only supports manual triggering via workflow_dispatch.
#
# SkillsMP (skillsmp.com) is a cross-agent skills marketplace that aggregates
# skills from public GitHub repos using the SKILL.md standard format.
#
# How SkillsMP discovery works:
#   SkillsMP auto-indexes public GitHub repositories that contain SKILL.md files.
#   If the repo is public and skills follow the SKILL.md standard, they should
#   appear on SkillsMP automatically. A marketplace.json at the repo root can
#   provide additional metadata for streamlined listing.
#
# Because SkillsMP indexes from GitHub directly, this workflow currently:
#   1. Validates that each skill has a well-formed SKILL.md
#   2. Optionally generates/validates marketplace.json for the plugin
#   3. Creates a git tag to signal a new skill release
#
# Once SkillsMP provides a CLI or publish API, update this workflow to push
# directly. Add tag-based triggers (e.g. on push tags: ['*/v*']) to automate.

name: Publish to SkillsMP

on:
  workflow_dispatch:
    inputs:
      plugin:
        description: 'Plugin name (top-level directory, e.g. "mobilerun")'
        required: true
        type: string
      tag_release:
        description: 'Create a git tag for this release (e.g. "mobilerun/skillsmp-v1.0.0"). Leave empty to validate only.'
        required: false
        type: string

permissions:
  contents: write

jobs:
  validate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Discover skills
        id: discover
        run: |
          PLUGIN="${{ inputs.plugin }}"
          SKILLS_DIR="${PLUGIN}/skills"

          if [ ! -d "$SKILLS_DIR" ]; then
            echo "::error::Skills directory not found: $SKILLS_DIR"
            exit 1
          fi

          # Find all skill directories containing a SKILL.md
          SKILL_PATHS=""
          COUNT=0
          for dir in "$SKILLS_DIR"/*/; do
            if [ -f "${dir}SKILL.md" ]; then
              SKILL_PATHS="${SKILL_PATHS}${dir}\n"
              COUNT=$((COUNT + 1))
            fi
          done

          if [ -z "$SKILL_PATHS" ]; then
            echo "::error::No skills found in $SKILLS_DIR (no directories with SKILL.md)"
            exit 1
          fi

          echo -e "Found $COUNT skill(s):\n$SKILL_PATHS"
          echo "skills_dir=$SKILLS_DIR" >> "$GITHUB_OUTPUT"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Validate SKILL.md files
        run: |
          SKILLS_DIR="${{ steps.discover.outputs.skills_dir }}"
          FAILED=0

          for dir in "$SKILLS_DIR"/*/; do
            if [ -f "${dir}SKILL.md" ]; then
              SKILL_FILE="${dir}SKILL.md"
              echo "::group::Validating $SKILL_FILE"

              # Check that SKILL.md has YAML frontmatter with required fields
              if ! head -1 "$SKILL_FILE" | grep -q "^---$"; then
                echo "::error file=$SKILL_FILE::Missing YAML frontmatter (must start with ---)"
                FAILED=1
                echo "::endgroup::"
                continue
              fi

              # Extract frontmatter
              FRONTMATTER=$(sed -n '/^---$/,/^---$/p' "$SKILL_FILE")

              # Check for required 'name' field
              if ! echo "$FRONTMATTER" | grep -q "^name:"; then
                echo "::error file=$SKILL_FILE::Missing required 'name' field in frontmatter"
                FAILED=1
              fi

              # Check for required 'description' field
              if ! echo "$FRONTMATTER" | grep -q "^description:"; then
                echo "::error file=$SKILL_FILE::Missing required 'description' field in frontmatter"
                FAILED=1
              fi

              # Check that there is content after frontmatter
              BODY_LINES=$(sed '1,/^---$/d' "$SKILL_FILE" | sed '1,/^---$/d' | grep -c '[^[:space:]]' || true)
              if [ "$BODY_LINES" -lt 1 ]; then
                echo "::warning file=$SKILL_FILE::SKILL.md has no content after frontmatter"
              fi

              echo "OK: $SKILL_FILE"
              echo "::endgroup::"
            fi
          done

          if [ "$FAILED" -ne 0 ]; then
            exit 1
          fi

          echo "All skills validated successfully."

      - name: Generate marketplace.json summary
        run: |
          PLUGIN="${{ inputs.plugin }}"
          SKILLS_DIR="${{ steps.discover.outputs.skills_dir }}"

          echo "Marketplace summary for plugin: $PLUGIN"
          echo "============================================"

          for dir in "$SKILLS_DIR"/*/; do
            if [ -f "${dir}SKILL.md" ]; then
              SKILL_NAME=$(sed -n '/^---$/,/^---$/{ /^name:/s/^name:[[:space:]]*//p }' "${dir}SKILL.md")
              SKILL_DESC=$(sed -n '/^---$/,/^---$/{ /^description:/s/^description:[[:space:]]*>*//p }' "${dir}SKILL.md")
              echo "  - $SKILL_NAME: $SKILL_DESC"
              echo "    Path: ${dir}SKILL.md"
            fi
          done

          echo ""
          echo "============================================"
          echo "These skills are discoverable by SkillsMP from this public repo."
          echo "If skills do not appear on skillsmp.com, verify the repo is public"
          echo "and that SKILL.md files follow the standard frontmatter format."

          # NOTE: If SkillsMP ever supports a marketplace.json for bulk registration,
          # generate it here. For now, SKILL.md-based auto-indexing is the mechanism.

      # NOTE: If SkillsMP provides a CLI or API in the future, add a publish step here:
      #
      # - name: Publish to SkillsMP
      #   run: |
      #     SKILLS_DIR="${{ steps.discover.outputs.skills_dir }}"
      #     for dir in "$SKILLS_DIR"/*/; do
      #       if [ -f "${dir}SKILL.md" ]; then
      #         echo "Publishing ${dir} to SkillsMP..."
      #         npx skillsmp publish "$dir"
      #       fi
      #     done
      #   env:
      #     SKILLSMP_TOKEN: ${{ secrets.SKILLSMP_TOKEN }}

      - name: Tag release
        if: inputs.tag_release != ''
        run: |
          TAG="${{ inputs.tag_release }}"
          echo "Creating tag: $TAG"
          git tag "$TAG"
          git push origin "$TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          PLUGIN="${{ inputs.plugin }}"
          COUNT="${{ steps.discover.outputs.count }}"

          echo "## SkillsMP Publish Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Plugin:** \`$PLUGIN\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Skills validated:** $COUNT" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -n "${{ inputs.tag_release }}" ]; then
            echo "**Tag created:** \`${{ inputs.tag_release }}\`" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "_No tag created (validate-only run)._" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "> **Note:** SkillsMP auto-indexes skills from public GitHub repos." >> "$GITHUB_STEP_SUMMARY"
          echo "> If skills don't appear on [skillsmp.com](https://skillsmp.com), verify the repo is public" >> "$GITHUB_STEP_SUMMARY"
          echo "> and SKILL.md files use valid frontmatter." >> "$GITHUB_STEP_SUMMARY"
